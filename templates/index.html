<!DOCTYPE html>
<head>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parete TAKTAK® - Sistema Professionale</title>
    <link rel="stylesheet" href="/static/css/style.css?v=4.1">
    <link rel="stylesheet" href="/static/css/moraletti-styles.css?v=3.0">
    <link rel="stylesheet" href="/static/css/materials-config.css?v=3.0">
    <link rel="stylesheet" href="/static/css/system-profiles.css?v=1.0">
    <link rel="stylesheet" href="/static/css/project-info-modal.css?v=1.4">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
</head>
<body>
    <!-- ✅ SISTEMA DI AUTENTICAZIONE GLOBALE -->
    <script src="/static/js/auth.js?v=3.1"></script>
    <script>
        // Inizializza l'autenticazione per questa pagina (protetta)
        document.addEventListener('DOMContentLoaded', function() {
            console.log('� Verifica autenticazione per dashboard...');
            
            // Verifica che l'utente sia autenticato
            if (!window.authManager.isLoggedIn()) {
                console.log('❌ Utente non autenticato - redirect al login');
                window.location.href = '/login';
                return;
            }
            
            console.log('✅ Utente autenticato - caricamento dashboard');
        });
    </script>

    <div id="app">
        <!-- Header with Navigation -->
        <header class="header">
            <div class="container">
                <div class="header-content">
                    <!-- Logo and Brand -->
                    <div class="logo-section">
                        <div class="logo-icon">
                            <i class="fas fa-layer-group"></i>
                        </div>
                        <div class="logo-text">
                            <h1>Parete TAKTAK<sup>®</sup></h1>
                            <span class="subtitle">Sistema Professionale di Progettazione</span>
                        </div>
                    </div>
                    
                    <!-- Navigation Menu -->
                    <nav class="main-nav">
                        <div class="nav-item active" data-section="app">
                            <i class="fas fa-play-circle"></i>
                            <span>Applicazione</span>
                        </div>
                        <div class="nav-item" data-section="library">
                            <i class="fas fa-cog"></i>
                            <span>Impostazioni Globali</span>
                        </div>
                        <div class="nav-item" data-section="settings">
                            <i class="fas fa-history"></i>
                            <span>Progetti Passati</span>
                        </div>
                    </nav>
                    
                    <!-- User Section - Semplice -->
                    <div class="user-section-simple" id="userSectionSimple">
                        <div class="user-info-simple" id="userInfoSimple">
                            <div class="user-avatar-simple">
                                <i class="fas fa-user"></i>
                            </div>
                            <span class="user-name-simple" id="userNameSimple">Caricamento...</span>
                            <div class="user-menu-toggle" id="userMenuToggle">
                                <i class="fas fa-chevron-down"></i>
                            </div>
                        </div>
                        
                        <!-- Menu Semplice -->
                        <div class="user-menu-simple" id="userMenuSimple" style="display: none;">
                            <button class="logout-btn-simple" id="logoutBtnSimple">
                                <i class="fas fa-sign-out-alt"></i>
                                Disconnetti
                            </button>
                        </div>
                    </div>
                    
                    <!-- Header Stats (shown only in app section) -->
                    <div class="header-stats" id="headerStats" style="display: none;">
                        <div class="stat-item">
                            <span class="stat-value" id="statStandard">0</span>
                            <span class="stat-label">Blocchi Standard</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="statCustom">0</span>
                            <span class="stat-label">Pezzi Custom</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="statEfficiency">0%</span>
                            <span class="stat-label">Efficienza</span>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content Container -->
        <main class="main-content">
            <div class="container">
                
                <!-- APPLICATION SECTION -->
                <div id="appSection" class="content-section active">
                    <!-- Step 1: Upload -->
                    <section class="step-section" id="uploadSection">
                        <div class="step-header">
                            <div class="step-number">1</div>
                            <div class="step-info">
                                <h2>Carica File CAD</h2>
                                <p>Seleziona o trascina il file CAD contenente la parete da costruire</p>
                            </div>
                        </div>
                        
                        <div class="upload-area" id="uploadArea">
                            <div class="upload-content">
                                <div class="upload-icon">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                </div>
                                <h3>Trascina qui il file CAD</h3>
                                <p>oppure <button type="button" class="link-button" id="selectFileBtn">seleziona file</button></p>
                                <div class="upload-info">
                                    <div class="format-support">
                                        <strong>Formati supportati:</strong>
                                        <ul>
                                            <li><i class="fas fa-check-circle text-success"></i> <strong>SVG</strong> - Supporto completo</li>
                                            <li><i class="fas fa-check-circle text-success"></i> <strong>DXF</strong> - Supporto completo</li>
                                            <li><i class="fas fa-check-circle text-success"></i> <strong>DWG</strong> - AutoCAD </li>
                                        </ul>
                                        
                                    </div>
                                </div>
                            </div>
                            <input type="file" id="fileInput" accept=".svg,.dwg,.dxf" style="display: none;">
                        </div>
                        
                        <div class="file-info" id="fileInfo" style="display: none;">
                            <div class="file-preview">
                                <div class="file-icon">
                                    <i class="fas fa-file-check"></i>
                                </div>
                                <div class="file-details">
                                    <div class="file-name" id="fileName"></div>
                                    <div class="file-meta" id="fileMeta"></div>
                                </div>
                                <button type="button" class="btn-icon" id="removeFile" title="Rimuovi file">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </section>

                    <!-- NEW Step 2: Preview -->
                    <section class="step-section" id="previewSection" style="display: none;">
                        <div class="step-header">
                            <div class="step-number">2</div>
                            <div class="step-info">
                                <h2>Anteprima Conversione</h2>
                                <p>Verifica che la conversione del file sia corretta prima di procedere</p>
                            </div>
                        </div>
                        
                        <div class="preview-container-main">
                            <!-- Preview Image -->
                            <div class="preview-card-main">
                                <div class="card-header">
                                    <h3><i class="fas fa-eye"></i> Anteprima Parete Convertita</h3>
                                    <div class="preview-actions">
                                        <button type="button" class="btn-icon" id="zoomInPreview" title="Ingrandisci">
                                            <i class="fas fa-search-plus"></i>
                                        </button>
                                        <button type="button" class="btn-icon" id="zoomOutPreview" title="Riduci">
                                            <i class="fas fa-search-minus"></i>
                                        </button>
                                        <button type="button" class="btn-icon" id="centerPreview" title="Centra">
                                            <i class="fas fa-crosshairs"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="image-container" id="previewImageContainer">
                                    <div class="preview-loading" id="previewLoadingMain">
                                        <div class="spinner"></div>
                                        <p>Conversione file in corso...</p>
                                    </div>
                                    <canvas id="previewCanvas" style="display: none;"></canvas>
                                    <!-- Visualizzazione offset poligono -->
                                    <div id="wallPreview" style="display: none; width: 100%; padding: 16px;"></div>
                                </div>
                            </div>
                            
                            <!-- Measurements Panel -->
                            <div class="measurements-panel">
                                <div class="measurements-header">
                                    <h3><i class="fas fa-ruler-combined"></i> Dimensioni Rilevate</h3>
                                </div>
                                <div class="measurements-content" id="measurementsContent">
                                    <div class="measurement-loading" id="measurementsLoading">
                                        <i class="fas fa-calculator"></i>
                                        <span>Calcolo dimensioni...</span>
                                    </div>
                                    <div class="measurements-data" id="measurementsData" style="display: none;">
                                        <div class="measurement-item">
                                            <span class="measurement-label">Area Totale:</span>
                                            <span class="measurement-value" id="totalArea">-- m²</span>
                                        </div>
                                        <div class="measurement-item">
                                            <span class="measurement-label">Larghezza Massima:</span>
                                            <span class="measurement-value" id="maxWidth">-- mm</span>
                                        </div>
                                        <div class="measurement-item">
                                            <span class="measurement-label">Altezza Massima:</span>
                                            <span class="measurement-value" id="maxHeight">-- mm</span>
                                        </div>
                                        <div class="measurement-item">
                                            <span class="measurement-label">Aperture Rilevate:</span>
                                            <span class="measurement-value" id="aperturesCount">-- elementi</span>
                                        </div>
                                        <div class="measurement-item">
                                            <span class="measurement-label">Perimetro:</span>
                                            <span class="measurement-value" id="wallPerimeter">-- mm</span>
                                        </div>
                                        <div class="measurement-item">
                                            <span class="measurement-label">Geometria:</span>
                                            <span class="measurement-value" id="geometryType">-- tipo</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Conversion Details -->
                                <div class="conversion-details" id="conversionDetails" style="display: none;">
                                    <div class="conversion-header">
                                        <h4><i class="fas fa-info-circle"></i> Dettagli Conversione</h4>
                                    </div>
                                    <div class="conversion-info">
                                        <div class="detail-item">
                                            <span class="detail-label">File Originale:</span>
                                            <span class="detail-value" id="originalFileName">--</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Formato:</span>
                                            <span class="detail-value" id="fileFormat">--</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Dimensione File:</span>
                                            <span class="detail-value" id="fileSize">--</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Stato Conversione:</span>
                                            <span class="detail-value status-success" id="conversionStatus">
                                                <i class="fas fa-check-circle"></i> Completata
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Validation Messages -->
                                <div class="validation-messages" id="validationMessages">
                                    <!-- Messages will be populated by JS -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Step Actions -->
                        <div class="step-actions">
                            <button type="button" class="btn btn-secondary" id="backToUploadFromPreview">
                                <i class="fas fa-arrow-left"></i> Indietro
                            </button>
                            <button type="button" class="btn btn-outline" id="reprocessFile">
                                <i class="fas fa-sync-alt"></i> Riconverti File
                            </button>
                            <button type="button" class="btn btn-primary" id="acceptPreview">
                                <i class="fas fa-check"></i> Conferma e Continua
                            </button>
                        </div>
                    </section>

                    <!-- Step 3: Project Parameters (formerly Step 2) -->
                    <section class="step-section" id="projectParamsSection" style="display: none;">
                        <div class="step-header">
                            <div class="step-number">3</div>
                            <div class="step-info">
                                <h2>Parametri di Progetto</h2>
                                <p>Inserisci le specifiche tecniche per il calcolo automatico delle misure</p>
                            </div>
                        </div>
                        
                        <div class="config-grid project-params-grid">
                            <!-- Material Configuration -->
                            <div class="config-card material-config-card">
                                <label>
                                    <i class="fas fa-layer-group"></i>
                                    Configurazione Materiale
                                </label>
                                <div class="param-row">
                                    <label for="materialType">Tipologia Materiale:</label>
                                    <select id="materialType" class="param-input">
                                        <option value="melamine">Melamina</option>
                                        <option value="mdf">MDF</option>
                                        <option value="chipboard">Truciolato</option>
                                        <option value="plywood">Multistrato</option>
                                        <!-- Custom materials will be added here dynamically -->
                                    </select>
                                </div>
                                <div class="param-row">
                                    <label for="materialThickness">Spessore Materiale (mm):</label>
                                    <input type="number" id="materialThickness" class="param-input" value="18" min="10" max="50" step="1" readonly>
                                    <span class="param-help">*Basato sul materiale selezionato</span>
                                </div>
                            </div>

                            <!-- Guide Configuration -->
                            <div class="config-card guide-config-card">
                                <label>
                                    <i class="fas fa-ruler-horizontal"></i>
                                    Configurazione Guide
                                </label>
                                <div class="param-row">
                                    <label>Tipologia Guide da Utilizzare:</label>
                                    <div class="guide-selector">
                                        <input type="radio" id="guide50" name="guideType" value="50" class="guide-radio">
                                        <label for="guide50" class="guide-option">
                                            <span class="guide-size">50mm</span>
                                            <span class="guide-desc">Guide Strette</span>
                                        </label>
                                        
                                        <input type="radio" id="guide75" name="guideType" value="75" class="guide-radio" checked>
                                        <label for="guide75" class="guide-option active">
                                            <span class="guide-size">75mm</span>
                                            <span class="guide-desc">Guide Standard</span>
                                        </label>
                                        
                                        <input type="radio" id="guide100" name="guideType" value="100" class="guide-radio">
                                        <label for="guide100" class="guide-option">
                                            <span class="guide-size">100mm</span>
                                            <span class="guide-desc">Guide Larghe</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="param-row">
                                    <label for="guideDepth">Profondità Guide (mm):</label>
                                    <input type="number" id="guideDepth" class="param-input" value="25" min="15" max="50" step="1">
                                </div>
                            </div>

                            <!-- Wall Position Configuration -->
                            <div class="config-card wall-position-card">
                                <label>
                                    <i class="fas fa-home"></i>
                                    Posizione Parete e Punti di Appoggio
                                </label>
                                <div class="param-row">
                                    <label>Tipologia Parete:</label>
                                    <div class="wall-type-selector">
                                        <input type="radio" id="wallNew" name="wallType" value="new" class="wall-radio" checked>
                                        <label for="wallNew" class="wall-option active">
                                            <i class="fas fa-plus-circle"></i>
                                            <span>Parete Nuova</span>
                                            <small>Parete indipendente</small>
                                        </label>
                                        
                                        <input type="radio" id="wallAttached" name="wallType" value="attached" class="wall-radio">
                                        <label for="wallAttached" class="wall-option">
                                            <i class="fas fa-link"></i>
                                            <span>Parete Attaccata</span>
                                            <small>Appoggiata a muri esistenti</small>
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- Attachment Points (shown only for attached walls) -->
                                <div id="attachmentPoints" class="attachment-config" style="display: none;">
                                    <div class="param-row">
                                        <label>Lati di Appoggio:</label>
                                        <div class="attachment-selector">
                                            <label class="attachment-point">
                                                <input type="checkbox" id="attachLeft" class="attachment-checkbox">
                                                <span class="attachment-label">
                                                    <i class="fas fa-arrow-left"></i> Sinistra
                                                </span>
                                            </label>
                                            <label class="attachment-point">
                                                <input type="checkbox" id="attachRight" class="attachment-checkbox">
                                                <span class="attachment-label">
                                                    <i class="fas fa-arrow-right"></i> Destra
                                                </span>
                                            </label>
                                            <label class="attachment-point">
                                                <input type="checkbox" id="attachTop" class="attachment-checkbox">
                                                <span class="attachment-label">
                                                    <i class="fas fa-arrow-up"></i> Alto
                                                </span>
                                            </label>
                                            <label class="attachment-point">
                                                <input type="checkbox" id="attachBottom" class="attachment-checkbox">
                                                <span class="attachment-label">
                                                    <i class="fas fa-arrow-down"></i> Basso
                                                </span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="param-help-box">
                                        <i class="fas fa-info-circle"></i>
                                        <span><strong>Importante:</strong> L'algoritmo inizierà il posizionamento dei blocchi dal lato fissato selezionato</span>
                                    </div>
                                </div>
                            </div>

                            <!-- System Profile Display -->
                            <div class="config-card system-profile-display-card">
                                <label>
                                    <i class="fas fa-cog"></i>
                                    Sistema Utilizzato
                                </label>
                                <div class="current-profile-display">
                                    <div class="profile-display-content">
                                        <div class="profile-icon">
                                            <i class="fas fa-cubes"></i>
                                        </div>
                                        <div class="profile-info">
                                            <span class="profile-name" id="displayedProfileName">Nessun profilo selezionato</span>
                                            <span class="profile-description" id="displayedProfileDesc">Seleziona un profilo nello Step 2</span>
                                        </div>
                                    </div>
                                    <div class="profile-specs" id="displayedProfileSpecs" style="display: none;">
                                        <div class="spec-item">
                                            <i class="fas fa-cube"></i>
                                            <span id="displayedBlocksCount">0 blocchi configurati</span>
                                        </div>
                                        <div class="spec-item">
                                            <i class="fas fa-brain"></i>
                                            <span id="displayedAlgorithmType" class="algorithm-badge-inline">Algoritmo non specificato</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Hidden inputs for advanced options (always enabled) -->
                            <input type="hidden" id="enableAutoMeasurements" checked>
                            <input type="hidden" id="enableCostEstimation" checked>
                        </div>

                        <!-- Parameters Summary -->
                        <div class="params-summary" id="paramsSummary">
                            <div class="summary-header">
                                <i class="fas fa-clipboard-check"></i>
                                <span>Riepilogo Parametri Impostati</span>
                            </div>
                            <div class="summary-content" id="paramsSummaryContent">
                                <div class="summary-item">
                                    <span class="summary-label">Materiale:</span>
                                    <span class="summary-value" id="summaryMaterial">Melamina 18mm</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Guide:</span>
                                    <span class="summary-value" id="summaryGuides">75mm Standard</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Tipologia:</span>
                                    <span class="summary-value" id="summaryWallType">Parete Nuova</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Sistema:</span>
                                    <span class="summary-value" id="summarySystem">Nessun profilo</span>
                                </div>
                            </div>
                        </div>

                        <div class="step-actions">
                            <button type="button" class="btn btn-secondary" id="backToUpload">
                                <i class="fas fa-arrow-left"></i> Indietro
                            </button>
                            <button type="button" class="btn btn-primary" id="proceedToConfig">
                                <i class="fas fa-arrow-right"></i> Continua
                            </button>
                        </div>
                    </section>

                    <!-- Step 4: Configuration (formerly Step 3) -->
                    <section class="step-section" id="configSection" style="display: none;">
                        <div class="step-header">
                            <div class="step-number">4</div>
                            <div class="step-info">
                                <h2>Configurazione Blocchi</h2>
                                <p>Personalizza le impostazioni di packing per ottimizzare il risultato</p>
                            </div>
                        </div>
                        
                        <div class="config-grid step4-layout">
                            <!-- 1. Nome Progetto card (FIRST - full width) -->
                            <div class="config-card config-card-full">
                                <label for="projectName">
                                    <i class="fas fa-project-diagram"></i>
                                    Nome Progetto
                                </label>
                                <input type="text" id="projectName" value="Progetto Parete" placeholder="Inserisci nome progetto">
                                
                                <!-- ===== NUOVO: Badge Snapshot Sistema ===== -->
                                <div id="snapshotBadge" class="snapshot-badge" style="display: none;">
                                    <i class="fas fa-history"></i>
                                    <span id="snapshotBadgeText">Configurazione snapshot del XX/XX/XXXX</span>
                                    <i class="fas fa-info-circle snapshot-info-icon" title="Questo progetto usa una configurazione di sistema salvata al momento della creazione"></i>
                                </div>
                            </div>
                            
                            <!-- 2. Spazi Verticali Card (SECOND - full width) -->
                            <div class="config-card vertical-spaces-card config-card-full">
                                <label class="section-label">
                                    <i class="fas fa-arrows-alt-v"></i>
                                    Spazi Verticali
                                </label>
                                
                                <div class="vertical-spaces-container">
                                    <!-- Card 1: Piedini Moraletti -->
                                    <div class="vertical-space-mini-card">
                                        <div class="mini-card-header">
                                            <label class="checkbox-label-inline">
                                                <input type="checkbox" id="enableGroundOffset">
                                                <span class="checkbox-text">
                                                    <i class="fas fa-level-up-alt"></i>
                                                    Spazio da Terra
                                                </span>
                                            </label>
                                        </div>
                                        <div class="mini-card-content" id="groundOffsetContent">
                                            <div class="config-row">
                                                <span class="config-label">Altezza da terra:</span>
                                                <div class="config-value">
                                                    <span class="value-number" id="groundOffsetValue">95</span>
                                                    <span class="value-unit">mm</span>
                                                </div>
                                            </div>
                                            <div class="config-note">
                                                <i class="fas fa-sync-alt"></i>
                                                Sincronizzato con moraletti
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Card 2: Spazio Soffitto -->
                                    <div class="vertical-space-mini-card">
                                        <div class="mini-card-header">
                                            <label class="checkbox-label-inline">
                                                <input type="checkbox" id="enableCeilingSpace">
                                                <span class="checkbox-text">
                                                    <i class="fas fa-level-down-alt"></i>
                                                    Spazio Soffitto
                                                </span>
                                            </label>
                                        </div>
                                        <div class="mini-card-content" id="ceilingSpaceInputGroup">
                                            <div class="config-row">
                                                <span class="config-label">Spazio:</span>
                                                <div class="config-input">
                                                    <input type="number" id="ceilingSpaceValue" value="100" min="0" max="500" step="10" class="space-input-field">
                                                    <span class="value-unit">mm</span>
                                                </div>
                                            </div>
                                            <div class="config-note">
                                                <i class="fas fa-arrow-down"></i>
                                                Riduce altezza ultima fila
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 3. Active Block Configuration Display (THIRD - full width) -->
                            <div class="config-card active-blocks-card config-card-full">
                                <label>
                                    <i class="fas fa-cubes"></i>
                                    Blocchi Configurati
                                    <button type="button" class="edit-blocks-btn" id="editBlocksBtn" onclick="openBlockLibrary()" style="display: none;">
                                        <i class="fas fa-edit"></i> Modifica in Libreria
                                    </button>
                                </label>
                                <div class="active-blocks-preview" id="activeBlocksPreview">
                                    <div class="active-block-item">
                                        <div class="block-mini-preview block-type1"></div>
                                        <div class="block-details">
                                            <span class="block-name">Tipo 1</span>
                                            <span class="block-dims" id="activeBlock1Dims">Caricamento...</span>
                                        </div>
                                    </div>
                                    <div class="active-block-item">
                                        <div class="block-mini-preview block-type2"></div>
                                        <div class="block-details">
                                            <span class="block-name">Tipo 2</span>
                                            <span class="block-dims" id="activeBlock2Dims">Caricamento...</span>
                                        </div>
                                    </div>
                                    <div class="active-block-item">
                                        <div class="block-mini-preview block-type3"></div>
                                        <div class="block-details">
                                            <span class="block-name">Tipo 3</span>
                                            <span class="block-dims" id="activeBlock3Dims">Caricamento...</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="blocks-usage-info">
                                    <small id="blocksUsageInfo"><i class="fas fa-info-circle"></i> Questi blocchi verranno utilizzati per il packing della parete</small>
                                    <small id="blocksLockInfo" style="display: none;"><i class="fas fa-lock"></i> Le dimensioni dei blocchi non possono essere modificate dopo aver caricato un file. Per cambiarle, inizia un nuovo progetto.</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            <button type="button" class="btn btn-secondary" id="backToPreviousStep">
                                <i class="fas fa-arrow-left"></i>
                                <span>Indietro</span>
                            </button>
                            <button type="button" class="btn btn-primary" id="processBtn">
                                <i class="fas fa-cogs"></i>
                                <span>Calcola Packing</span>
                            </button>
                        </div>
                    </section>

                    <!-- Step 5: Results (formerly Step 4) -->
                    <section class="step-section" id="resultsSection" style="display: none;">
                        <div class="step-header">
                            <div class="step-number">5</div>
                            <div class="step-info">
                                <h2>Risultati Packing</h2>
                                <p>Visualizza il layout calcolato e scarica i risultati</p>
                            </div>
                            <!-- Stats Cards next to title -->
                            <div class="results-stats-cards">
                                <div class="stat-card">
                                    <div class="stat-card-value" id="statStandardResults">0</div>
                                    <div class="stat-card-label">BLOCCHI STANDARD</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-card-value" id="statCustomResults">0</div>
                                    <div class="stat-card-label">PEZZI CUSTOM</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-card-value" id="statEfficiencyResults">0%</div>
                                    <div class="stat-card-label">BLOCCHI TOTALI</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="results-grid">
                            <!-- Preview Area -->
                            <div class="preview-card">
                                <div class="card-header">
                                    <h3><i class="fas fa-eye"></i> Preview Parete</h3>
                                    <div class="preview-controls">
                                        <button type="button" class="btn-icon" id="refreshPreview" title="Aggiorna preview">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>
                                        <button type="button" class="btn-icon" id="fullscreenPreview" title="Schermo intero">
                                            <i class="fas fa-expand"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="preview-container" id="previewContainer">
                                    <div class="preview-loading" id="previewLoading">
                                        <div class="spinner"></div>
                                        <p>Parete in costruzione, attendere...</p>
                                    </div>
                                    <img id="previewImage" style="display: none;" alt="Preview parete">
                                </div>
                                
                                <!-- Configuration Info Card - Below Preview -->
                                <div class="configuration-card" id="configurationCard" style="display: none; margin-top: 20px;">
                                    <h3>
                                        <i class="fas fa-cog"></i> 
                                        Riassunto Configurazione Progetto
                                    </h3>
                                    <div class="config-info-grid">
                                        <div class="config-section" id="materialSection" style="display: none;">
                                            <h4>Materiale</h4>
                                            <div id="materialInfo"></div>
                                        </div>
                                        <div class="config-section" id="guideSection" style="display: none;">
                                            <h4>Guide</h4>
                                            <div id="guideInfo"></div>
                                        </div>
                                        <div class="config-section" id="blockSection" style="display: none;">
                                            <h4>Blocchi</h4>
                                            <div id="blockInfo"></div>
                                        </div>
                                        <div class="config-section" id="morettiSection" style="display: none;">
                                            <h4>Moraletti</h4>
                                            <div id="morettiInfo"></div>
                                        </div>
                                        <div class="config-section" id="constructionSection" style="display: none;">
                                            <h4>Costruzione</h4>
                                            <div id="constructionInfo"></div>
                                        </div>
                                        <div class="config-section" id="closureSection" style="display: none;">
                                            <h4>Spessore Chiusura</h4>
                                            <div id="closureInfo"></div>
                                        </div>
                                        <div class="config-section" id="wallSection" style="display: none;">
                                            <h4>Configurazione Parete</h4>
                                            <div id="wallInfo"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Summary Tables -->
                            <div class="summary-cards">
                                <!-- Standard Blocks -->
                                <div class="summary-card">
                                    <h3>
                                        <i class="fas fa-cubes"></i> 
                                        <span id="standardBlocksTitle">Blocchi Standard (Raggruppati)</span>
                                        <span id="customBlocksIndicator" class="custom-blocks-indicator" style="display: none;">
                                            <i class="fas fa-tools" title="Dimensioni personalizzate"></i>
                                        </span>
                                    </h3>
                                    <div class="table-container">
                                        <table id="standardTable">
                                            <thead>
                                                <tr>
                                                    <th>Categoria</th>
                                                    <th>Quantità</th>
                                                    <th>Dimensioni</th>
                                                    <th>Numerazione</th>
                                                    <th>Moraletti</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Populated by JS -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <!-- Custom Pieces -->
                                <div class="summary-card">
                                    <h3><i class="fas fa-puzzle-piece"></i> Pezzi Custom (Raggruppati)</h3>
                                    <div class="table-container">
                                        <table id="customTable">
                                            <thead>
                                                <tr>
                                                    <th>Categoria</th>
                                                    <th>Quantità</th>
                                                    <th>Dimensioni</th>
                                                    <th>Numerazione</th>
                                                    <th>Moraletti</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Populated by JS -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            <button type="button" class="btn btn-success" id="downloadPDF">
                                <i class="fas fa-file-pdf"></i>
                                <span>Scarica PDF</span>
                            </button>
                            <button type="button" class="btn btn-primary" id="downloadDXF">
                                <i class="fas fa-drafting-compass"></i>
                                <span>Scarica DXF</span>
                            </button>
                            <button type="button" class="btn btn-primary" id="downloadJSON">
                                <i class="fas fa-file-code"></i>
                                <span>Scarica JSON</span>
                            </button>
                            <button type="button" class="btn btn-secondary" id="reconfigureBtn">
                                <i class="fas fa-cogs"></i>
                                <span>Riconfigurazione</span>
                            </button>
                            <button type="button" class="btn btn-outline" id="newProjectBtn">
                                <i class="fas fa-plus"></i>
                                <span>Nuovo Progetto</span>
                            </button>
                        </div>
                    </section>
                </div>
                
                <!-- LIBRARY SECTION -->
                <div id="librarySection" class="content-section">
                    <div class="page-header">
                        <div class="page-icon">
                            <i class="fas fa-cog"></i>
                        </div>
                        <div class="page-info">
                            <h1>Impostazioni Globali</h1>
                            <p>Configurazioni generali del sistema e personalizzazioni</p>
                            <p style="margin-top: 10px; padding: 10px; background-color: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px; font-size: 0.9em;">
                                <i class="fas fa-info-circle" style="color: #856404;"></i> 
                                <strong>NB:</strong> Per aprire o chiudere le configurazioni, cliccare sull'icona della freccia 
                                <i class="fas fa-chevron-down" style="font-size: 0.8em;"></i> 
                                in alto a destra.
                            </p>
                        </div>
                    </div>
                    
                    <div class="features-grid">
                        
                        <!-- Profile Selector Card (Prima di tutto) -->
                        <div class="feature-card profile-selector-card">
                            <div class="feature-icon">
                                <i class="fas fa-sliders-h"></i>
                            </div>
                            <div class="feature-content" style="flex: 1;">
                                <h3>Profilo Sistema Attivo</h3>
                                <p>Seleziona il profilo di configurazione da utilizzare</p>
                            </div>
                            <div class="profile-selector-container-inline">
                                <select id="activeProfileSelector" class="profile-selector-inline">
                                    <option value="">Caricamento...</option>
                                </select>
                            </div>
                        </div>
                        <!-- Custom Materials Configuration Card -->
                        <div class="feature-card custom-materials-card">
                            <div class="feature-icon">
                                <i class="fas fa-layer-group"></i>
                            </div>
                            <div class="feature-content">
                                <h3>Configurazione Materiali Personalizzati <i class="fas fa-chevron-down expand-icon" id="customMaterialsExpandIcon" onclick="toggleCustomMaterialsPanel()" style="cursor: pointer;"></i></h3>
                                <p>Crea e gestisci i tuoi materiali personalizzati</p>
                                
                                <!-- How it works explanation -->
                                <div class="system-explanation">
                                    <div class="explanation-header">
                                        <i class="fas fa-info-circle"></i>
                                        <strong>Come funziona:</strong>
                                    </div>
                                    <ol class="explanation-steps">
                                        <li><strong>Aggiungi materiale:</strong> Inserisci nome e spessore del materiale personalizzato</li>
                                        <li><strong>Salva:</strong> Il materiale verrà salvato e disponibile nello Step 3</li>
                                        <li><strong>Gestisci:</strong> Modifica o elimina i materiali esistenti quando necessario</li>
                                    </ol>
                                </div>
                                
                                <!-- Custom Materials Panel (Initially Hidden) -->
                                <div class="custom-materials-panel" id="customMaterialsPanel" style="display: none;">
                                    
                                    <!-- Add New Material Section -->
                                    <div class="add-material-section">
                                        <h4><i class="fas fa-plus-circle"></i> Aggiungi Nuovo Materiale</h4>
                                        <div class="material-form">
                                            <div class="material-input-group">
                                                <label for="newMaterialName">Tipologia Materiale:</label>
                                                <input type="text" id="newMaterialName" placeholder="Es: MDF Premium" class="material-input">
                                            </div>
                                            <div class="material-input-group">
                                                <label for="newMaterialThickness">Spessore (mm):</label>
                                                <input type="number" id="newMaterialThickness" placeholder="18" min="1" max="100" class="material-input">
                                            </div>
                                            <button class="add-material-btn" onclick="event.stopPropagation(); addCustomMaterial()">
                                                <i class="fas fa-plus"></i> Aggiungi Materiale
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Existing Materials List -->
                                    <div class="materials-list-section">
                                        <h4><i class="fas fa-list"></i> Materiali Salvati</h4>
                                        <div class="materials-grid" id="customMaterialsList">
                                            <!-- Materials will be dynamically inserted here -->
                                            <div class="empty-state" id="emptyMaterialsState">
                                                <i class="fas fa-inbox"></i>
                                                <p>Nessun materiale personalizzato ancora creato</p>
                                                <span>Aggiungi il tuo primo materiale usando il form sopra</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- System Profiles Configuration Card -->
                        <div class="feature-card system-profiles-card">
                            <div class="feature-icon">
                                <i class="fas fa-save"></i>
                            </div>
                            <div class="feature-content">
                                <h3>Profili Sistema <i class="fas fa-chevron-down expand-icon" id="systemProfilesExpandIcon" onclick="toggleSystemProfilesPanel()" style="cursor: pointer;"></i></h3>
                                <p>Gestisci preset di configurazione completi per blocchi e moraletti</p>
                                
                                <!-- How it works explanation -->
                                <div class="system-explanation">
                                    <div class="explanation-header">
                                        <i class="fas fa-info-circle"></i>
                                        <strong>Come funziona:</strong>
                                    </div>
                                    <ol class="explanation-steps">
                                        <li><strong>Crea profilo:</strong> Salva una configurazione completa di blocchi e moraletti</li>
                                        <li><strong>Seleziona:</strong> Usa il selettore in alto per cambiare rapidamente configurazione</li>
                                        <li><strong>Gestisci:</strong> Modifica o elimina i profili esistenti</li>
                                    </ol>
                                </div>
                                
                                <!-- System Profiles Panel (Initially Hidden) -->
                                <div class="system-profiles-panel" id="systemProfilesPanel" style="display: none;">
                                    
                                    <!-- Create New Profile Button -->
                                    <div class="create-profile-section">
                                        <button class="create-profile-btn" onclick="event.stopPropagation(); openProfileModal()">
                                            <i class="fas fa-plus-circle"></i> Crea Nuovo Profilo Sistema
                                        </button>
                                    </div>
                                    
                                    <!-- Existing Profiles List -->
                                    <div class="profiles-list-section">
                                        <h4><i class="fas fa-list"></i> Profili Salvati</h4>
                                        <div class="profiles-grid" id="systemProfilesList">
                                            <!-- Profiles will be dynamically inserted here -->
                                            <div class="loading-state" id="profilesLoadingState">
                                                <i class="fas fa-spinner fa-spin"></i>
                                                <p>Caricamento profili...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Wall Inner Offset Configuration Card -->
                        <div class="feature-card offset-configuration-card">
                            <div class="feature-icon">
                                <i class="fas fa-compress-arrows-alt"></i>
                            </div>
                            <div class="feature-content">
                                <h3>Offset Parete Interna <i class="fas fa-chevron-down expand-icon" id="offsetExpandIcon" onclick="toggleOffsetPanel()" style="cursor: pointer;"></i></h3>
                                <p>Riduci il poligono verso l'interno per margini di sicurezza o guide perimetrali</p>
                                
                                <!-- How it works explanation -->
                                <div class="system-explanation">
                                    <div class="explanation-header">
                                        <i class="fas fa-info-circle"></i>
                                        <strong>Come funziona:</strong>
                                    </div>
                                    <ol class="explanation-steps">
                                        <li><strong>Abilita offset:</strong> Attiva la funzione per applicare una riduzione al perimetro della parete</li>
                                        <li><strong>Imposta distanza:</strong> Specifica di quanti millimetri ridurre il poligono verso l'interno</li>
                                        <li><strong>Visualizzazione automatica:</strong> Allo Step 2 vedrai il poligono originale (blu) e quello ridotto (verde)</li>
                                        <li><strong>Packing su offset:</strong> L'algoritmo posizionerà i blocchi sul poligono ridotto</li>
                                    </ol>
                                    <div class="explanation-note">
                                        <i class="fas fa-ruler-horizontal"></i>
                                        <em><strong>Nota:</strong> L'offset si applica SOLO al perimetro esterno della parete, le aperture (porte/finestre) restano invariate</em>
                                    </div>
                                </div>
                                
                                <!-- Offset Configuration Panel (Initially Hidden) -->
                                <div class="offset-panel" id="offsetPanel" style="display: none;">
                                    
                                    <!-- Enable Offset Checkbox -->
                                    <div class="offset-enable-section">
                                        <label class="checkbox-label-inline offset-checkbox">
                                            <input type="checkbox" id="enableInnerOffset">
                                            <span class="checkbox-text">
                                                <i class="fas fa-toggle-on"></i>
                                                <strong>Abilita Offset Interno</strong>
                                            </span>
                                        </label>
                                    </div>
                                    
                                    <!-- Offset Distance Input -->
                                    <div class="offset-input-section" id="offsetInputSection" style="display: none;">
                                        <div class="offset-control-group">
                                            <label for="offsetDistance">
                                                <i class="fas fa-ruler"></i> Distanza Offset:
                                            </label>
                                            <div class="offset-input-wrapper">
                                                <input 
                                                    type="number" 
                                                    id="offsetDistance" 
                                                    value="50" 
                                                    min="0" 
                                                    max="500" 
                                                    step="10" 
                                                    class="offset-input"
                                                    onchange="updateOffsetInfo()"
                                                >
                                                <span class="input-unit-large">mm</span>
                                            </div>
                                            <div class="offset-slider-wrapper">
                                                <input 
                                                    type="range" 
                                                    id="offsetSlider" 
                                                    min="0" 
                                                    max="500" 
                                                    step="10" 
                                                    value="50" 
                                                    class="offset-slider"
                                                    oninput="updateOffsetFromSlider()"
                                                >
                                            </div>
                                        </div>
                                        
                                        <!-- Offset Info Display -->
                                        <div class="offset-info-display">
                                            <div class="offset-info-icon">
                                                <i class="fas fa-info-circle"></i>
                                            </div>
                                            <div class="offset-info-text">
                                                Il poligono sarà ridotto di <strong id="offsetValueDisplay">50mm</strong> su tutti i lati del perimetro esterno.
                                                <br>
                                                <small style="color: #6B7280; margin-top: 5px; display: block;">
                                                    <i class="fas fa-lightbulb"></i> Usa casi: margini di sicurezza, spazio per guide, correzione dimensioni nominali
                                                </small>
                                            </div>
                                        </div>
                                        
                                        <!-- Visual Example -->
                                        <div class="offset-visual-example">
                                            <div class="example-title">
                                                <i class="fas fa-eye"></i> Anteprima Concetto:
                                            </div>
                                            <div class="example-diagram">
                                                <svg viewBox="0 0 200 120" xmlns="http://www.w3.org/2000/svg" style="width: 100%; height: auto; max-width: 300px;">
                                                    <!-- Poligono originale (blu tratteggiato) -->
                                                    <rect x="10" y="10" width="180" height="100" 
                                                          fill="rgba(59, 130, 246, 0.1)" 
                                                          stroke="#3B82F6" 
                                                          stroke-width="2" 
                                                          stroke-dasharray="5,5"/>
                                                    <text x="100" y="25" text-anchor="middle" fill="#3B82F6" font-size="10" font-weight="bold">Originale</text>
                                                    
                                                    <!-- Poligono offset (verde) -->
                                                    <rect x="30" y="30" width="140" height="60" 
                                                          fill="rgba(34, 197, 94, 0.2)" 
                                                          stroke="#22C55E" 
                                                          stroke-width="2"/>
                                                    <text x="100" y="65" text-anchor="middle" fill="#22C55E" font-size="10" font-weight="bold">Area Packing</text>
                                                    
                                                    <!-- Frecce distanza -->
                                                    <line x1="10" y1="115" x2="30" y2="115" stroke="#EF4444" stroke-width="1.5" marker-end="url(#arrowhead)"/>
                                                    <text x="20" y="112" text-anchor="middle" fill="#EF4444" font-size="9" font-weight="bold">Offset</text>
                                                    
                                                    <defs>
                                                        <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="5" refY="3" orient="auto">
                                                            <polygon points="0 0, 10 3, 0 6" fill="#EF4444"/>
                                                        </marker>
                                                    </defs>
                                                </svg>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Save Button -->
                                    <div class="offset-actions">
                                        <button class="btn btn-primary save-offset-btn" onclick="event.stopPropagation(); saveOffsetConfiguration()">
                                            <i class="fas fa-save"></i> Salva Configurazione Offset
                                        </button>
                                        <div class="offset-save-feedback" id="offsetSaveFeedback" style="display: none;">
                                            <i class="fas fa-check-circle"></i>
                                            <span>Configurazione salvata! Si applicherà automaticamente ai nuovi upload.</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Block Dimensions Configuration Card -->
                        <div class="feature-card block-dimensions-card">
                            <div class="feature-icon">
                                <i class="fas fa-ruler-combined"></i>
                            </div>
                            <div class="feature-content">
                                <h3>Dimensioni Blocchi Standard <i class="fas fa-chevron-down expand-icon" id="blockDimensionsExpandIcon" onclick="toggleBlockDimensionsPanel()" style="cursor: pointer;"></i></h3>
                                <p>Configura le misure dei 3 tipi di blocchi standard</p>
                                
                                <!-- How it works explanation for Block Configuration -->
                                <div class="system-explanation">
                                    <div class="explanation-header">
                                        <i class="fas fa-info-circle"></i>
                                        <strong>Come funziona il sistema:</strong>
                                    </div>
                                    <ol class="explanation-steps">
                                        <li><strong>Modifica dimensioni:</strong> Inserisci le dimensioni dei blocchi secondo le tue esigenze</li>
                                        <li><strong>Salva configurazione:</strong> Clicca "Salva Configurazione" per abilitare la configurazione moraletti</li>
                                    </ol>
                                    <div class="explanation-note">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        <em><strong>Importante:</strong> Le larghezze devono rispettare l'ordine: Blocco 1 (Grande) > Blocco 2 (Medio) > Blocco 3 (Piccolo)</em>
                                    </div>
                                </div>
                                
                                <!-- Block Dimensions Panel (Initially Hidden) -->
                                <div class="block-dimensions-panel" id="blockDimensionsPanel" style="display: none;">
                                    
                                    <!-- Block Type 1 -->
                                    <div class="block-group">
                                        <h4><i class="fas fa-cube"></i> Blocco Standard Tipo 1</h4>
                                        <div class="dimensions-controls">
                                            <div class="dimension-control">
                                                <label for="block1Width">Larghezza (mm):</label>
                                                <div class="number-input-group">
                                                    <input type="number" id="block1Width" value="1239" min="400" max="1500" class="dimension-input">
                                                    <span class="unit">mm</span>
                                                </div>
                                            </div>
                                            <div class="dimension-control">
                                                <label for="block1Height">Altezza (mm):</label>
                                                <div class="number-input-group">
                                                    <input type="number" id="block1Height" value="495" min="200" max="800" class="dimension-input">
                                                    <span class="unit">mm</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Block Type 2 -->
                                    <div class="block-group">
                                        <h4><i class="fas fa-cube"></i> Blocco Standard Tipo 2</h4>
                                        <div class="dimensions-controls">
                                            <div class="dimension-control">
                                                <label for="block2Width">Larghezza (mm):</label>
                                                <div class="number-input-group">
                                                    <input type="number" id="block2Width" value="826" min="400" max="1500" class="dimension-input">
                                                    <span class="unit">mm</span>
                                                </div>
                                            </div>
                                            <div class="dimension-control">
                                                <label for="block2Height">Altezza (mm):</label>
                                                <div class="number-input-group">
                                                    <input type="number" id="block2Height" value="495" min="200" max="800" class="dimension-input" readonly>
                                                    <span class="unit">mm</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Block Type 3 -->
                                    <div class="block-group">
                                        <h4><i class="fas fa-cube"></i> Blocco Standard Tipo 3</h4>
                                        <div class="dimensions-controls">
                                            <div class="dimension-control">
                                                <label for="block3Width">Larghezza (mm):</label>
                                                <div class="number-input-group">
                                                    <input type="number" id="block3Width" value="413" min="200" max="800" class="dimension-input">
                                                    <span class="unit">mm</span>
                                                </div>
                                            </div>
                                            <div class="dimension-control">
                                                <label for="block3Height">Altezza (mm):</label>
                                                <div class="number-input-group">
                                                    <input type="number" id="block3Height" value="495" min="200" max="800" class="dimension-input" readonly>
                                                    <span class="unit">mm</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Comparison Section -->
                                    <div class="blocks-comparison">
                                        <h4><i class="fas fa-chart-bar"></i> Confronto Blocchi</h4>
                                        <div class="comparison-grid">
                                            <div class="comparison-item">
                                                <strong>Tipo 1</strong>
                                                <div class="comparison-bar">
                                                    <div class="bar bar-type1" id="comparisonBar1"></div>
                                                </div>
                                                <span id="comparisonRatio1">100%</span>
                                            </div>
                                            <div class="comparison-item">
                                                <strong>Tipo 2</strong>
                                                <div class="comparison-bar">
                                                    <div class="bar bar-type2" id="comparisonBar2"></div>
                                                </div>
                                                <span id="comparisonRatio2">75%</span>
                                            </div>
                                            <div class="comparison-item">
                                                <strong>Tipo 3</strong>
                                                <div class="comparison-bar">
                                                    <div class="bar bar-type3" id="comparisonBar3"></div>
                                                </div>
                                                <span id="comparisonRatio3">50%</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Action Buttons -->
                                    <div class="block-actions">
                                        <div class="block-actions-row">
                                            <button class="preset-btn-small reset-btn" onclick="event.stopPropagation(); resetToSystemDefaults()">
                                                ↺ Reset Standard
                                            </button>
                                            <button class="save-block-dimensions-btn" onclick="event.stopPropagation(); saveBlockDimensionsEnhanced()">
                                                ✓ Salva Configurazione
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Moraletti Configuration Card -->
                        <div class="feature-card moraletti-card" id="moralettiCardContainer">
                            <div class="feature-icon">
                                <i class="fas fa-columns"></i>
                            </div>
                            <div class="feature-content">
                                <h3>Configurazione Moraletti <i class="fas fa-chevron-down expand-icon" id="moralettiExpandIcon" onclick="toggleMoralettiPanel()" style="cursor: pointer;"></i></h3>
                                <p>Sistema di incastro verticale con pilastri in acciaio</p>
                                
                                <!-- How it works explanation -->
                                <div class="system-explanation" id="moralettiExplanation">
                                    <div class="explanation-header">
                                        <i class="fas fa-info-circle"></i>
                                        <strong>Come funziona il sistema moraletti:</strong>
                                    </div>
                                    <ol class="explanation-steps">
                                        <li><strong>Configura i blocchi:</strong> Prima devi salvare le dimensioni dei 3 blocchi standard</li>
                                        <li><strong>Spaziatura automatica:</strong> Il sistema propone spaziatura ottimale = Blocco Grande ÷ 3</li>
                                        <li><strong>Salva:</strong> Conferma configurazione per usarla nell'algoritmo di packing</li>
                                    </ol>
                                    <div class="explanation-note">
                                        <i class="fas fa-shield-alt"></i>
                                        <em>Una volta salvati i moraletti, per modificarli devi riconfermare prima i blocchi</em>
                                    </div>
                                </div>
                                
                                <!-- Prerequisites Warning -->
                                <div class="prerequisite-warning" id="moralettiPrerequisiteWarning" style="display: block;">
                                    <div class="warning-content">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        <span>Prima configura e conferma le dimensioni dei blocchi</span>
                                    </div>
                                </div>
                                
                                <!-- Moraletti Configuration Panel (Initially Hidden) -->
                                <div class="moraletti-panel" id="moralettiPanel" style="display: none;">
                                    
                                    <!-- Configuration Controls Section BEFORE Preview -->
                                    <div class="moraletti-controls-section">
                                        <h4><i class="fas fa-sliders-h"></i> Parametri Moraletti</h4>
                                        
                                        <div class="controls-grid">
                                            <div class="control-group">
                                                <label for="moralettiThickness">Larghezza (mm)</label>
                                                <div class="control-input-wrapper">
                                                    <input type="number" id="moralettiThickness" value="58" min="30" max="100" class="control-input">
                                                    <span class="input-unit">mm</span>
                                                </div>
                                            </div>
                                            
                                            <div class="control-group">
                                                <label for="moralettiHeight">Altezza (mm)</label>
                                                <div class="control-input-wrapper">
                                                    <input type="number" id="moralettiHeight" value="495" min="200" max="800" class="control-input">
                                                    <span class="input-unit">mm</span>
                                                </div>
                                            </div>
                                            
                                            <div class="control-group">
                                                <label for="moralettiHeightFromGround">Altezza da Terra (Piedini) (mm)</label>
                                                <div class="control-input-wrapper">
                                                    <input type="number" id="moralettiHeightFromGround" value="0" min="0" max="200" class="control-input">
                                                    <span class="input-unit">mm</span>
                                                </div>
                                                <div class="auto-suggestion">
                                                    <span style="font-size: 11px;">⬇ Quanto il moraletto sporge SOTTO il blocco (es. 95mm = piedini che sollevano il blocco)</span>
                                                </div>
                                            </div>
                                            
                                            <div class="control-group">
                                                <label for="moralettiSpacing">Spaziatura Base (mm)</label>
                                                <div class="control-input-wrapper">
                                                    <input type="number" id="moralettiSpacing" value="413" min="200" max="800" class="control-input">
                                                    <span class="input-unit">mm</span>
                                                </div>
                                                <div class="auto-suggestion" id="spacingSuggestion">
                                                    <span>💡 Spaziatura Calcolata Automaticamente: <strong id="suggestedSpacing">-</strong></span>
                                                </div>
                                            </div>
                                            
                                            <div class="control-group">
                                                <label for="moralettiCountLarge">N° Moraletti Blocco Grande</label>
                                                <div class="control-input-wrapper">
                                                    <input type="number" id="moralettiCountLarge" value="3" min="1" max="5" class="control-input">
                                                    <span class="input-unit">pz</span>
                                                </div>
                                            </div>
                                            
                                            <div class="control-group">
                                                <label for="moralettiCountMedium">N° Moraletti Blocco Medio</label>
                                                <div class="control-input-wrapper">
                                                    <input type="number" id="moralettiCountMedium" value="2" min="1" max="5" class="control-input">
                                                    <span class="input-unit">pz</span>
                                                </div>
                                            </div>
                                            
                                            <div class="control-group">
                                                <label for="moralettiCountSmall">N° Moraletti Blocco Piccolo</label>
                                                <div class="control-input-wrapper">
                                                    <input type="number" id="moralettiCountSmall" value="1" min="1" max="5" class="control-input">
                                                    <span class="input-unit">pz</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Current Configuration Summary -->
                                    <div class="moraletti-summary">
                                        <div class="summary-row">
                                            <span class="summary-label">Configurazione Attiva:</span>
                                            <span class="summary-value" id="moralettiActiveSummary">58mm × 495mm, spaziatura 413mm</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Visual Preview Section AFTER Input -->
                                    <div class="moraletti-visual-section" id="moralettiVisualSection" style="display: none;">
                                        <h4><i class="fas fa-eye"></i> Anteprima Configurazioni</h4>
                                        
                                        <!-- Dynamic preview will be inserted here by JavaScript -->
                                        <div id="moralettiPreviewContainer">
                                            <!-- Previews generated dynamically -->
                                        </div>
                                        
                                        <!-- Alignment Status -->
                                        <div class="alignment-status-enhanced">
                                            <div class="status-indicator">
                                                <i class="fas fa-check-circle status-icon" id="enhancedAlignmentIcon"></i>
                                                <span class="status-text" id="enhancedAlignmentStatus">Allineamento verticale garantito</span>
                                            </div>
                                            <div class="alignment-details">
                                                <small>I moraletti si allineano perfettamente secondo l'immagine tecnica</small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Actions -->
                                    <div class="moraletti-actions-section">
                                        <div class="main-actions">
                                            <button class="action-btn secondary-btn" id="resetMoralettiBtn" onclick="event.stopPropagation(); resetMoralettiDefaults()" disabled>
                                                <i class="fas fa-undo"></i> Reset
                                            </button>
                                            <button class="action-btn secondary-btn" onclick="event.stopPropagation(); generateMoralettiPreview()">
                                                <i class="fas fa-eye"></i> Genera Preview
                                            </button>
                                            <button class="action-btn primary-btn" id="saveMoralettiBtn" onclick="event.stopPropagation(); saveMoralettiConfiguration()" disabled>
                                                <i class="fas fa-save"></i> Salva Configurazione
                                            </button>
                                        </div>
                                        <div class="protection-warning" id="moralettiProtectionWarning">
                                            <i class="fas fa-lock"></i>
                                            <span>Prima salva la configurazione dei blocchi per abilitare queste azioni</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Color Theme Customization Card -->
                        <div class="feature-card color-theme-card">
                            <div class="feature-icon">
                                <i class="fas fa-palette"></i>
                            </div>
                            <div class="feature-content">
                                <h3>Temi Personalizzati <i class="fas fa-chevron-down expand-icon" id="colorThemeExpandIcon" onclick="toggleColorThemePanel()" style="cursor: pointer;"></i></h3>
                                <p>Personalizza i colori dei blocchi e degli elementi</p>
                                
                                <!-- How it works explanation for Color Themes -->
                                <div class="system-explanation">
                                    <div class="explanation-header">
                                        <i class="fas fa-info-circle"></i>
                                        <strong>Come funziona il sistema:</strong>
                                    </div>
                                    <ol class="explanation-steps">
                                        <li><strong>Seleziona colori:</strong> Scegli i colori per ogni tipo di elemento (blocchi, porte/finestre, contorni)</li>
                                        <li><strong>Usa preset:</strong> Utilizza le configurazioni rapide (Default, Alto Contrasto, Colorato) per partire</li>
                                        <li><strong>Anteprima e salva:</strong> Visualizza il risultato in tempo reale e salva il tema personalizzato</li>
                                    </ol>
                                    <div class="explanation-note">
                                        <i class="fas fa-palette"></i>
                                        <em>I colori si applicano immediatamente all'anteprima per una visualizzazione in tempo reale</em>
                                    </div>
                                </div>
                                
                                <!-- Color Settings Panel (Initially Hidden) -->
                                <div class="color-settings-panel" id="colorSettingsPanel" style="display: none;">
                                    <div class="color-group">
                                        <h4><i class="fas fa-cubes"></i> Blocchi Standard</h4>
                                        <div class="color-controls">
                                            <div class="color-control">
                                                <label for="standardBlockColor">Colore Riempimento:</label>
                                                <div class="color-input-group">
                                                    <input type="color" id="standardBlockColor" value="#E5E7EB" class="color-picker">
                                                    <input type="text" id="standardBlockColorText" value="#E5E7EB" class="color-text">
                                                </div>
                                            </div>
                                            <div class="color-control">
                                                <label for="standardBlockBorder">Colore Bordo:</label>
                                                <div class="color-input-group">
                                                    <input type="color" id="standardBlockBorder" value="#374151" class="color-picker">
                                                    <input type="text" id="standardBlockBorderText" value="#374151" class="color-text">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="color-group">
                                        <h4><i class="fas fa-door-open"></i> Porte e Finestre</h4>
                                        <div class="color-controls">
                                            <div class="color-control">
                                                <label for="doorWindowColor">Colore Riempimento:</label>
                                                <div class="color-input-group">
                                                    <input type="color" id="doorWindowColor" value="#FEE2E2" class="color-picker">
                                                    <input type="text" id="doorWindowColorText" value="#FEE2E2" class="color-text">
                                                </div>
                                            </div>
                                            <div class="color-control">
                                                <label for="doorWindowBorder">Colore Bordo:</label>
                                                <div class="color-input-group">
                                                    <input type="color" id="doorWindowBorder" value="#DC2626" class="color-picker">
                                                    <input type="text" id="doorWindowBorderText" value="#DC2626" class="color-text">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="color-group">
                                        <h4><i class="fas fa-vector-square"></i> Contorno Parete</h4>
                                        <div class="color-controls">
                                            <div class="color-control">
                                                <label for="wallOutlineColor">Colore Contorno:</label>
                                                <div class="color-input-group">
                                                    <input type="color" id="wallOutlineColor" value="#1E40AF" class="color-picker">
                                                    <input type="text" id="wallOutlineColorText" value="#1E40AF" class="color-text">
                                                </div>
                                            </div>
                                            <div class="color-control">
                                                <label for="wallLineWidth">Spessore Linea:</label>
                                                <div class="range-input-group">
                                                    <input type="range" id="wallLineWidth" min="1" max="5" value="2" class="range-slider">
                                                    <span class="range-value">2px</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="color-group">
                                        <h4><i class="fas fa-puzzle-piece"></i> Pezzi Custom</h4>
                                        <div class="color-controls">
                                            <div class="color-control">
                                                <label for="customPieceColor">Colore Riempimento:</label>
                                                <div class="color-input-group">
                                                    <input type="color" id="customPieceColor" value="#F3E8FF" class="color-picker">
                                                    <input type="text" id="customPieceColorText" value="#F3E8FF" class="color-text">
                                                </div>
                                            </div>
                                            <div class="color-control">
                                                <label for="customPieceBorder">Colore Bordo:</label>
                                                <div class="color-input-group">
                                                    <input type="color" id="customPieceBorder" value="#7C3AED" class="color-picker">
                                                    <input type="text" id="customPieceBorderText" value="#7C3AED" class="color-text">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Preview Section -->
                                    <div class="color-preview-section">
                                        <h4><i class="fas fa-eye"></i> Anteprima Colori</h4>
                                        <div class="color-preview-grid">
                                            <div class="preview-item">
                                                <div class="preview-block standard-block" id="previewStandardBlock"></div>
                                                <span>Blocco Standard</span>
                                            </div>
                                            <div class="preview-item">
                                                <div class="preview-block door-window-block" id="previewDoorWindow"></div>
                                                <span>Porta/Finestra</span>
                                            </div>
                                            <div class="preview-item">
                                                <div class="preview-block custom-piece-block" id="previewCustomPiece"></div>
                                                <span>Pezzo Custom</span>
                                            </div>
                                            <div class="preview-item">
                                                <div class="preview-outline" id="previewWallOutline"></div>
                                                <span>Contorno</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    
                                    <!-- Action Buttons -->
                                    <div class="color-actions">
                                        <button class="preset-btn" onclick="event.stopPropagation(); applyPreset('default')">
                                            <i class="fas fa-undo"></i> Default
                                        </button>
                                        <button class="preset-btn" onclick="event.stopPropagation(); applyPreset('highContrast')">
                                            <i class="fas fa-adjust"></i> Alto Contrasto
                                        </button>
                                        <button class="preset-btn" onclick="event.stopPropagation(); applyPreset('colorful')">
                                            <i class="fas fa-rainbow"></i> Colorato
                                        </button>
                                        <button class="save-btn primary-btn" onclick="event.stopPropagation(); saveColorTheme()">
                                            <i class="fas fa-save"></i> Salva Tema
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
                
                <!-- SETTINGS SECTION -->
                <div id="settingsSection" class="content-section">
                    <div class="page-header">
                        <div class="page-icon">
                            <i class="fas fa-history"></i>
                        </div>
                        <div class="page-info">
                            <h1>Progetti Passati</h1>
                            <p>Archivio e gestione dei progetti completati</p>
                        </div>
                    </div>
                    
                    <div class="features-grid">
                        <!-- Past Projects Card -->
                        <div class="feature-card past-projects-card" onclick="togglePastProjectsPanel()">
                            <div class="feature-icon">
                                <i class="fas fa-folder-open"></i>
                            </div>
                            <div class="feature-content">
                                <h3>
                                    Progetti Salvati 
                                    <span class="projects-count-badge" id="projectsCountBadge" style="display: none;">0</span>
                                    <i class="fas fa-chevron-down expand-icon" id="pastProjectsExpandIcon"></i>
                                </h3>
                                <p>Riutilizza progetti precedenti con le stesse configurazioni</p>
                                
                                <!-- Past Projects Panel (Initially Hidden) -->
                                <div class="past-projects-panel" id="pastProjectsPanel" style="display: none;">
                                    <div class="past-projects-header">
                                        <div class="search-bar">
                                            <i class="fas fa-search"></i>
                                            <input type="text" id="projectSearchInput" placeholder="Cerca progetti..." class="search-input">
                                        </div>
                                    </div>
                                    
                                    <!-- Projects List Container -->
                                    <div class="past-projects-list" id="pastProjectsList">
                                        <div class="loading-placeholder">
                                            <i class="fas fa-spinner fa-spin"></i>
                                            <span>Caricamento progetti...</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Empty State -->
                                    <div class="empty-projects-state" id="emptyProjectsState" style="display: none;">
                                        <i class="fas fa-folder-open"></i>
                                        <h4>Nessun progetto presente</h4>
                                        <p>Completa un progetto per salvarlo e poterlo riutilizzare in futuro</p>
                                    </div>
                                    
                                    <!-- Action Buttons -->
                                    <div class="past-projects-actions">
                                        <button class="refresh-btn" onclick="event.stopPropagation(); refreshPastProjects()" title="Ricarica l'elenco dei progetti salvati">
                                            <i class="fas fa-sync-alt"></i> 
                                            <span>Aggiorna Lista</span>
                                        </button>
                                        <button class="clear-archive-btn" onclick="event.stopPropagation(); clearAllProjects()" title="Elimina tutti i progetti dall'archivio">
                                            <i class="fas fa-trash-alt"></i> 
                                            <span>Pulisci Archivio</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
        </main>

        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loadingOverlay" style="display: none;">
            <div class="loading-content">
                <div class="spinner-large"></div>
                <h3 id="loadingTitle">Elaborazione in corso...</h3>
                <p id="loadingMessage">Analisi file SVG e calcolo packing automatico</p>
            </div>
        </div>

        <!-- Toast Notifications -->
        <div class="toast-container" id="toastContainer"></div>

        <!-- Fullscreen Preview Modal -->
        <div class="modal-overlay" id="fullscreenModal" style="display: none;">
            <div class="modal-content fullscreen-modal">
                <div class="modal-header">
                    <h3><i class="fas fa-expand"></i> Preview Parete - Schermo Intero</h3>
                    <button type="button" class="btn-icon" id="closeFullscreen">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <img id="fullscreenImage" alt="Preview parete fullscreen">
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Material Confirmation Modal -->
    <div id="deleteMaterialModal" class="modal" style="display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center;">
        <div class="modal-content" style="background-color: #fefefe; margin: auto; padding: 0; border: 1px solid #888; border-radius: 12px; max-width: 650px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); animation: slideIn 0.3s ease;">
            <div class="modal-header" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; padding: 20px; border-radius: 12px 12px 0 0;">
                <h2 style="margin: 0; font-size: 1.3em;">
                    <i class="fas fa-exclamation-triangle"></i> Conferma Eliminazione
                </h2>
            </div>
            <div class="modal-body" style="padding: 35px;">
                <div style="display: flex; align-items: center; gap: 25px;">
                    <!-- Icona cestino a sinistra -->
                    <div style="font-size: 4em; color: #dc3545; flex-shrink: 0;">
                        <i class="fas fa-trash-alt"></i>
                    </div>
                    
                    <!-- Contenuto centrale (verticale) -->
                    <div style="flex: 1; display: flex; flex-direction: column; gap: 18px;">
                        <!-- Domanda -->
                        <h3 style="margin: 0; color: #333; font-size: 1.15em; text-align: left;">Sei sicuro di voler eliminare questo materiale?</h3>
                        
                        <!-- Box rosso con nome materiale -->
                        <div style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; padding: 15px 20px; border-radius: 10px; font-size: 1.15em; font-weight: 600; text-align: center; box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);">
                            <span id="deleteMaterialName"></span>
                        </div>
                        
                        <!-- Avviso irreversibile -->
                        <div style="display: flex; align-items: center; gap: 10px; color: #856404; font-size: 0.9em; font-weight: 500;">
                            <i class="fas fa-info-circle" style="font-size: 1.4em; color: #ffc107; flex-shrink: 0;"></i>
                            <span>Questa azione è irreversibile!</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="display: flex; gap: 10px; justify-content: center; padding: 20px; background-color: #f8f9fa; border-top: 1px solid #dee2e6; border-radius: 0 0 12px 12px;">
                <button type="button" class="btn-secondary" onclick="closeMaterialDeleteModal()" style="padding: 12px 30px; min-width: 120px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;">
                    <i class="fas fa-times"></i> Annulla
                </button>
                <button type="button" id="confirmDeleteMaterialBtn" class="btn-danger" style="padding: 12px 30px; min-width: 120px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;">
                    <i class="fas fa-trash"></i> Elimina
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="app-footer">
        <p class="footer-text">© 2025 ZENET SRL</p>
    </footer>

    <!-- System Profile Modal -->
    <div id="profileModal" class="modal" style="display: none; position: fixed; z-index: 10001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center;">
        <div class="modal-content" style="background-color: #fefefe; margin: 50px auto; padding: 0; border: 1px solid #888; border-radius: 12px; max-width: 800px; max-height: 90vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2 style="margin: 0; font-size: 1.5em;"><i class="fas fa-cog"></i> <span id="profileModalTitle">Crea Nuovo Profilo Sistema</span></h2>
                    <p style="margin: 5px 0 0 0; font-size: 0.9em; opacity: 0.9;">Configura dimensioni blocchi e moraletti</p>
                </div>
                <button onclick="closeProfileModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; cursor: pointer; width: 40px; height: 40px; border-radius: 50%; transition: all 0.3s;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div style="padding: 30px;">
                <!-- Profile Name and Description -->
                <div class="modal-section">
                    <h3 style="color: #667eea; margin-bottom: 15px;"><i class="fas fa-tag"></i> Informazioni Profilo</h3>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="profileName" style="display: block; margin-bottom: 5px; font-weight: 600;">Nome Profilo:</label>
                        <input type="text" id="profileName" placeholder="Es: TakTak Big" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 1em;">
                    </div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="profileDescription" style="display: block; margin-bottom: 5px; font-weight: 600;">Descrizione (opzionale):</label>
                        <textarea id="profileDescription" placeholder="Es: Sistema per pareti grandi" rows="2" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 1em; resize: vertical;"></textarea>
                    </div>
                </div>

                <!-- Block Dimensions -->
                <div class="modal-section" style="margin-top: 25px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;"><i class="fas fa-cube"></i> Dimensioni Blocchi</h3>
                    
                    <!-- Block 1 -->
                    <div class="block-config-group" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #333;">Blocco Grande (Tipo 1)</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-size: 0.9em;">Larghezza (mm):</label>
                                <input type="number" id="modalBlock1Width" value="1239" min="400" max="1500" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-size: 0.9em;">Altezza (mm):</label>
                                <input type="number" id="modalBlock1Height" value="495" min="200" max="800" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                        </div>
                    </div>

                    <!-- Block 2 -->
                    <div class="block-config-group" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #333;">Blocco Medio (Tipo 2)</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-size: 0.9em;">Larghezza (mm):</label>
                                <input type="number" id="modalBlock2Width" value="826" min="300" max="1000" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-size: 0.9em;">Altezza (mm):</label>
                                <input type="number" id="modalBlock2Height" value="495" min="200" max="800" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                        </div>
                    </div>

                    <!-- Block 3 -->
                    <div class="block-config-group" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #333;">Blocco Piccolo (Tipo 3)</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-size: 0.9em;">Larghezza (mm):</label>
                                <input type="number" id="modalBlock3Width" value="413" min="200" max="800" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-size: 0.9em;">Altezza (mm):</label>
                                <input type="number" id="modalBlock3Height" value="495" min="200" max="800" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Moraletti Configuration -->
                <div class="modal-section" style="margin-top: 25px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;"><i class="fas fa-grip-vertical"></i> Configurazione Moraletti</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 0.9em;">Spessore (mm):</label>
                            <input type="number" id="modalMoralettiThickness" value="58" min="10" max="100" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 0.9em;">Altezza (mm):</label>
                            <input type="number" id="modalMoralettiHeight" value="495" min="100" max="1000" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 0.9em;">Altezza da Terra (mm):</label>
                            <input type="number" id="modalMoralettiHeightFromGround" value="95" min="0" max="200" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 0.9em;">Spaziatura (mm):</label>
                            <input type="number" id="modalMoralettiSpacing" value="420" min="100" max="800" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    </div>

                    <h4 style="margin: 15px 0 10px 0; color: #555;">Numero Moraletti per Blocco:</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 0.9em;">Blocco Grande:</label>
                            <input type="number" id="modalMoralettiCountLarge" value="3" min="1" max="5" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 0.9em;">Blocco Medio:</label>
                            <input type="number" id="modalMoralettiCountMedium" value="2" min="1" max="5" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 0.9em;">Blocco Piccolo:</label>
                            <input type="number" id="modalMoralettiCountSmall" value="1" min="1" max="5" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    </div>
                </div>

                <!-- Algorithm Selection -->
                <div class="modal-section" style="margin-top: 25px;">
                    <h3 style="color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 8px; margin-bottom: 15px;">
                        <i class="fas fa-brain"></i> Algoritmo di Packing
                    </h3>
                    <select id="modalAlgorithmType" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 1em; cursor: pointer; background: white;">
                        <option value="small">🏠 SMALL - Costruzione Residenziale (senza sfalsamento blocchi)</option>
                        <option value="big">🏭 BIG - Costruzione Industriale (con sfalsamento blocchi)</option>
                    </select>
                    <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-left: 4px solid #667eea; border-radius: 4px; font-size: 0.9em; line-height: 1.6;">
                        <strong>📘 Guida:</strong><br>
                        <strong>SMALL:</strong> Allineamento verticale perfetto, ideale per costruzioni residenziali e interni.<br>
                        <strong>BIG:</strong> Pattern sfalsato tipo "mattoni" per maggiore stabilità strutturale in edifici industriali.
                    </div>
                </div>

                <!-- Make Default Checkbox -->
                <div class="modal-section" style="margin-top: 25px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="modalIsDefault" style="width: 20px; height: 20px; margin-right: 10px; cursor: pointer;">
                        <span style="font-weight: 600;">Imposta come profilo predefinito</span>
                    </label>
                </div>

                <!-- Action Buttons -->
                <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="closeProfileModal()" style="padding: 12px 24px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer; font-size: 1em; transition: all 0.3s;">
                        <i class="fas fa-times"></i> Annulla
                    </button>
                    <button onclick="saveProfile()" style="padding: 12px 24px; border: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 6px; cursor: pointer; font-size: 1em; font-weight: 600; transition: all 0.3s;">
                        <i class="fas fa-save"></i> Salva Profilo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/smart-loading.js?v=3.0"></script>
    <script src="/static/js/moraletti-helper.js?v=1.0"></script>
    <script src="/static/js/offset-config.js?v=1.0"></script>
    <script src="/static/js/offset-visualization.js?v=1.0"></script>
    <script src="/static/js/app.js?v=3.7"></script>
    <script src="/static/js/user-section.js?v=3.0"></script>
    <script src="/static/js/system-profiles.js?v=1.1"></script>
</body>
</html>